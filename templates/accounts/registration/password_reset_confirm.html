{% extends 'public/base_public.html' %}
{% load django_bootstrap5 %}

{% block title %}Set New Password — Starter Kit{% endblock %}

{% block content %}
<div class="pub-auth">
    <div class="pub-auth-card pub-anim">

        {# Step indicators #}
        <div class="pub-auth-steps">
            <div class="pub-auth-step done"></div>
            <div class="pub-auth-step done"></div>
            <div class="pub-auth-step done"></div>
        </div>

        <div class="pub-auth-logo">
            <div class="pub-auth-icon-wrap">
                <i class="bi bi-lock-fill"></i>
            </div>
        </div>

        <h1 class="pub-auth-title">Set new password</h1>
        <p class="pub-auth-sub">
            Choose a strong password you haven't used before.
        </p>

        {% if validlink %}
            <form method="post" novalidate>
                {% csrf_token %}

                {# New password #}
                <div class="mb-1">
                    <label for="id_new_password1" class="form-label">New password</label>
                </div>
                <div class="mb-1 position-relative">
                    <input type="password"
                           class="form-control {% if form.new_password1.errors %}is-invalid{% endif %}"
                           id="id_new_password1"
                           name="new_password1"
                           placeholder="Min. 8 characters"
                           autocomplete="new-password"
                           required autofocus>
                    <button type="button"
                            onclick="togglePw('id_new_password1', this)"
                            class="btn btn-link position-absolute top-50 end-0 translate-middle-y pe-3 text-muted p-0 border-0"
                            tabindex="-1">
                        <i class="bi bi-eye" style="font-size:.95rem;"></i>
                    </button>
                    {% if form.new_password1.errors %}
                        <div class="invalid-feedback d-block">{{ form.new_password1.errors.0 }}</div>
                    {% endif %}
                </div>
                {# Strength meter #}
                <div class="pub-pw-strength mb-3">
                    <div class="pub-pw-bar"></div>
                    <div class="pub-pw-bar"></div>
                    <div class="pub-pw-bar"></div>
                </div>

                {# Confirm new password #}
                <div class="mb-4 position-relative">
                    <label for="id_new_password2" class="form-label">Confirm new password</label>
                    <input type="password"
                           class="form-control {% if form.new_password2.errors %}is-invalid{% endif %}"
                           id="id_new_password2"
                           name="new_password2"
                           placeholder="••••••••"
                           autocomplete="new-password"
                           required>
                    <button type="button"
                            onclick="togglePw('id_new_password2', this)"
                            class="btn btn-link position-absolute bottom-0 end-0 pe-3 text-muted p-0 border-0"
                            style="height:42px;" tabindex="-1">
                        <i class="bi bi-eye" style="font-size:.95rem;"></i>
                    </button>
                    {% if form.new_password2.errors %}
                        <div class="invalid-feedback">{{ form.new_password2.errors.0 }}</div>
                    {% endif %}
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-lg me-1"></i> Set new password
                </button>
            </form>
        {% else %}
            {# Invalid / expired link #}
            <div class="alert alert-danger" style="border-radius:8px; font-size:.875rem;">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                This password reset link is <strong>invalid or has expired</strong>.
                Reset links are only valid for 24 hours.
            </div>
            <a href="{% url 'accounts:password_reset' %}" class="pub-btn-solid d-block text-center">
                <i class="bi bi-arrow-repeat me-1"></i> Request a new link
            </a>
        {% endif %}

        <p class="pub-auth-footer mt-4">
            <a href="{% url 'accounts:login' %}"><i class="bi bi-arrow-left me-1"></i> Back to sign in</a>
        </p>
    </div>
</div>

<script>
function togglePw(id, btn) {
    const el = document.getElementById(id);
    const icon = btn.querySelector('i');
    el.type = el.type === 'password' ? 'text' : 'password';
    icon.className = el.type === 'password' ? 'bi bi-eye' : 'bi bi-eye-slash';
}
</script>
{% endblock %}